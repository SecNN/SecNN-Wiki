# 任意文件下载（读取）漏洞

#### 🔍产生原因

1. 功能设计问题：
   - 系统提供了文件下载或查看功能，并允许用户通过参数变量指定文件。
   - 后端使用文件读取函数获取用户请求的文件内容。
2. 安全校验缺失：
   - 未对用户输入的参数进行有效校验，或校验逻辑不严格。
   - 开发者未限制用户访问的文件范围，导致可以读取系统任意文件。
3. 文件内容输出：
   - 后端将读取的文件内容直接输出或提供给客户端，未对文件内容进行安全处理。

#### 💻利用条件

1. 存在文件读取函数：
   - 后端代码中存在可读取文件的函数（如 `readfile()` 或 `fopen()` 等）。
2. 路径可控且未校验：
   - 用户可以通过参数控制文件读取路径，且后端未对路径进行严格校验或限制。
3. 文件内容泄露：
   - 系统允许将文件内容输出或下载到客户端，直接暴露敏感信息。

#### 📖常见下载参数特征

参数名可能包含（但不限于）：
`file`, `filename`, `path`, `url`, `document`, `doc`, `download`, `filepath`, `filename`, `load`, `read`, `retrieve`, `display`, `pathfile`, `data`

#### 📌漏洞利用方法

任意文件下载漏洞，正常的利用手段是下载服务器文件，比如脚本代码、服务器配置文件或者是系统配置文件等。但有时并不知道网站所处环境以及网站路径，就可以使用../../../进行逐层猜测路径，案例如下：

```
index.php?f=../../../../../../../../../etc/passwd
index.php?f=../../../index.php
index.php?f=filename:///etc/passwd
file.php?filename=/etc/passwd
file.php?filename=../../../../../etc/passwd
file.php?filename=../../../../../../../etc/passwd%00   // 00截断
```

**⚠️绕过手法**

1. **双写绕过**
    **适用场景**：当后端对路径中的 `../` 做了置空或删除处理时。
    **示例**：
   - 输入路径：`..././config`
   - 后端处理：删除 `../` 后，实际路径变为 `../config`
   - 结果：成功绕过路径校验。
2. **编码绕过**
    **常用编码方式**：URL 编码、双重 URL 编码、十六进制编码等。
    **绕过原理**：
   - URL 编码通常会被后端自动解析一次（如 `%2e%2e%2f` 解析为 `../`）。
   - 其他编码（如十六进制）需测试后端是否支持解析。
     **示例**：
   - 输入路径：`%2e%2e%2fetc%2fpasswd`（URL 编码后的 `../etc/passwd`）。
3. **请求混淆绕过**
    **常见手法**：HTTP 参数污染（HPP）、分块传输、填充垃圾字符等。
    **特点**：通用性强，可用于干扰后端处理逻辑。
    **示例**：
   - 注入冗余参数：`filename=config&ignore=../`。
   - 分块传输或填充无效字符以绕过长度或格式检查。

##### Windows 系统下常用敏感文件路径

```
C:\boot.ini //查看系统版本
C:\Windows\System32\inetsrv\MetaBase.xml          //IIS配置文件
C:\Windows\repair\sam                               //存储系统初次安装的密码
C:\Program Files\mysql\my.ini                               //Mysql配置
C:\Program Files\mysql\data\mysql\user.MYD     //Mysql root
C:\Windows\php.ini              //php配置信息
C:\Windows\my.ini             //Mysql配置信息
C:\Windows\win.ini             //Windows系统的一个基本系统配置文件
/Windows/System32/drivers/etc/HOSTS  
```

##### Linux 系统下常用敏感文件路径

```
/root/.ssh/authorized_keys
/root/.ssh/id_rsa
/root/.ssh/id_ras.keystore
/root/.ssh/known_hosts
/etc/passwd
/etc/shadow
/etc/issue 系统版本
/etc/fstab
/etc/host.conf
/var/log/xferlog                   FTP会话，记录拷贝了什么文件
/var/log/cron                     计划任务日志
/etc/(cron.d/|crontab)                //这两个也是定时任务文件
/var/log/secure                   用户登录安全日志
/etc/rc.local                          读apache的路径
/etc/motd
/etc/sysctl.conf
/var/log/syslog                   记录登陆错误时的密码等信息
/etc/environment                     环境变量配置文件 可能泄露大量目录信息
/etc/inputrc                             输入设备配置文件
/etc/default/useradd        添加用户的默认信息的文件
/etc/login.defs        是用户密码信息的默认属性
/etc/skel                            用户信息的骨架
/sbin/nologin                         不能登陆的用户
/var/log/message                  系统的日志文件
/etc/httpd/conf/httpd.conf                 配置http服务的配置文件
/etc/mtab                              包含当前安装的文件系统列表   有时可以读取到当前网站的路径
/etc/ld.so.conf
/etc/my.cnf                       mysql配置文件
/etc/httpd/conf/httpd.conf        Apache配置文件
/root/.bash_history                  终端命令操作记录
/root/.mysql_history
/proc/mounts
/porc/config.gz
/var/lib/mlocate/mlocate.db         Linux系统全文件路径数据库
/porc/self/cmdline
/usr/local/app/apache2/conf/httpd.conf    //apache2默认配置文件
/usr/local/app/apache2/conf/extra/httpd-vhosts.conf   //虚拟网站设置
/usr/local/app/php5/lib/php.ini   //php相关设置
/etc/httpd/conf/httpd.conf        //apache配置文件
/etc/php5/apache2/php.ini         //ubuntu系统的默认路径
```

**Tomcat**

```
tomcat/conf/tomcat-users.xml  tomcat管理员账号密码的配置文件
apache-tomcat/conf/tomcat-users.xml  //tomcat的角色(授权用户)配置文件
tomcat/conf/server.xml   tomcat连接数据库的密码配置文件
tomcat/webapps/ROOT/WEB-INF/classes/database.properties
apache-tomcat/conf/web.xml    //tomcat应用程序的部署描述符文件
apache-tomcat/logs/catalina.out    //即tomcat的标准输出和标准出错，所有输出到这两个位置的都会进入catalina.out，这里包含tomcat运行自己输出的日志以及应用里向console输出的日志。
```

**Web应用**

```
PHP：获取inc/config.php文件，获得数据库连接字符串中的口令信息；
ASP：获取inc/conn.asp文件，获得数据库连接字符串口令，得到数据库口令。若是ACCESS数据库，可以得到数据库路径，再下载数据库内容；
ASPX：获取网站根目录web.config文件，获得数据库连接字符串中的口令信息；
获取bin/*.dll文件，获取网站源码（不完整代码），使用.NET reflector工具打开编译后的dll文件；
JSP：获取conf/tomcat-user.xml文件，获得tongcat管理界面的口令信息，上传war包GetShell；
获取WEB-INF/Web.xml文件，获得数据库连接字符串中的口令信息。
```

#### **🛡️修复建议**

##### **1. 限制文件访问目录**

- **措施**：在服务器配置文件（如Nginx、Apache或应用配置）中，明确限定用户可访问的文件目录范围。

- 示例(NGINX)：

  ```
  location /downloads {
      root /var/www/safe-dir;
  }
  ```

- **效果**：即使恶意用户尝试越权访问，也无法读取系统其他目录的文件。

##### **2. 严格校验用户输入**

- 关键点：对用户输入的文件路径或名称进行过滤和转义，禁止包含以下危险字符或序列：
  - 目录跳转符：`../`、`..\`、`./`
  - 终止符/截断符：`%00`（空字节）、`#`
  - 特殊符号：`..`（双重父级目录）
- 实现方式：
  - 使用正则表达式匹配并拦截非法字符。
  - 在代码层面强制标准化路径（如PHP的`realpath()`函数）。

##### **3. 输入内容合法性校验**

- **文件类型**：验证上传或下载的文件扩展名是否符合预期。

- **文件地址**：检查路径是否在允许范围内。

- **文件内容**：通过文件头（Magic Number）或内容扫描，确保文件未被篡改。

- 示例代码（Python）：

  ```
  ALLOWED_EXTENSIONS = {'jpg', 'png', 'pdf'}
  if not file.filename.lower().endswith(tuple(ALLOWED_EXTENSIONS)):
      raise ValueError("非法文件类型")
  ```

##### **4. 白名单控制文件路径**

- **策略**：仅允许访问预先定义的白名单目录和文件名，拒绝其他所有请求。

- **优势**：比黑名单更安全，避免遗漏可能的绕过手法。

- 实现示例（Java）：

  ```
  String safeDir = "/var/www/uploads/";
  String userPath = request.getParameter("file");
  Path resolvedPath = Paths.get(safeDir).resolve(userPath).normalize();
  if (!resolvedPath.startsWith(safeDir)) {
      throw new SecurityException("非法路径访问");
  }
  ```

##### **5. 限制文件扩展名**

- 白名单后缀：仅允许下载以下常见安全文件类型：
  - 图片：`jpg`、`gif`、`png`
  - 文档：`pdf`、`doc`、`xls`、`ppt`
  - 压缩包：`zip`、`rar`
- **动态校验**：结合MIME类型检测，防止伪装扩展名的攻击。

